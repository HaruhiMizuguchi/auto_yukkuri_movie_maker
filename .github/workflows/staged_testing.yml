name: Staged Testing Strategy

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Phase 1: æ¢ç´¢ãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ®µéš
  phase1_exploration:
    if: contains(github.event.head_commit.message, '[phase1]') || contains(github.ref, 'feature/explore')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock pytest-cov
        pip install -r requirements.txt
    
    - name: Run Phase 1 Tests (Unit Only)
      run: |
        echo "ğŸ” Phase 1: æ¢ç´¢çš„å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        pytest tests/unit/ -v --tb=short
        echo "â„¹ï¸  çµ±åˆãƒ†ã‚¹ãƒˆã¯æ„å›³çš„ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæŸ”è»Ÿæ€§å„ªå…ˆï¼‰"
    
    - name: Check Phase 1 Success Criteria
      run: |
        python scripts/check_phase1_criteria.py

  # Phase 2: å®‰å®šåŒ–ãƒ»MVPæ®µéš  
  phase2_stabilization:
    if: contains(github.event.head_commit.message, '[phase2]') || contains(github.ref, 'feature/stabilize')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock pytest-cov
        pip install -r requirements.txt
    
    - name: Run Phase 2 Tests (Unit + Contract + Critical Integration)
      run: |
        echo "âš–ï¸  Phase 2: ãƒãƒ©ãƒ³ã‚¹é‡è¦–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        pytest tests/unit/ tests/contracts/ tests/integration/critical/ -v
        echo "â„¹ï¸  ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å›ºå®šãƒ»é‡è¦çµ±åˆã®ã¿"
    
    - name: Interface Stability Check
      run: |
        python scripts/check_interface_stability.py
    
    - name: Critical Integration Verification
      run: |
        python scripts/verify_critical_integrations.py

  # Phase 3: æœ¬æ ¼å®Ÿè£…æ®µéš
  phase3_production:
    if: contains(github.event.head_commit.message, '[phase3]') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock pytest-cov pytest-xdist
        pip install -r requirements.txt
    
    - name: Run Complete Test Suite
      run: |
        echo "ğŸ¯ Phase 3: å®Œå…¨å“è³ªä¿è¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        pytest tests/ -v --cov=src --cov-report=html --cov-report=xml
        echo "âœ… å…¨ãƒ¬ãƒ™ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆå˜ä½“ãƒ»çµ±åˆãƒ»E2Eï¼‰å®Ÿè¡Œ"
    
    - name: E2E Test Execution
      run: |
        pytest tests/e2e/ -v --tb=short
    
    - name: Performance Tests
      run: |
        pytest tests/performance/ -v
    
    - name: Production Quality Check
      run: |
        python scripts/check_production_quality.py
    
    - name: Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ±ºå®šï¼ˆè‡ªå‹•ï¼‰
  determine_test_strategy:
    runs-on: ubuntu-latest
    outputs:
      test_phase: ${{ steps.determine.outputs.phase }}
      
    steps:
    - uses: actions/checkout@v3
    
    - name: Determine Test Phase
      id: determine
      run: |
        # ãƒ–ãƒ©ãƒ³ãƒåã¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰è‡ªå‹•åˆ¤å®š
        if [[ "${{ github.ref }}" == *"feature/explore"* ]] || [[ "${{ github.event.head_commit.message }}" == *"[phase1]"* ]]; then
          echo "phase=1" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == *"feature/stabilize"* ]] || [[ "${{ github.event.head_commit.message }}" == *"[phase2]"* ]]; then
          echo "phase=2" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          echo "phase=3" >> $GITHUB_OUTPUT
        else
          echo "phase=2" >> $GITHUB_OUTPUT  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Phase 2
        fi
    
    - name: Display Test Strategy
      run: |
        echo "ğŸ¯ æ±ºå®šã•ã‚ŒãŸãƒ†ã‚¹ãƒˆæˆ¦ç•¥: Phase ${{ steps.determine.outputs.phase }}"
        case "${{ steps.determine.outputs.phase }}" in
          "1") echo "ğŸ“ æŸ”è»Ÿæ€§å„ªå…ˆï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ" ;;
          "2") echo "âš–ï¸  ãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼šå¥‘ç´„ãƒ†ã‚¹ãƒˆ + é‡è¦çµ±åˆãƒ†ã‚¹ãƒˆ" ;;
          "3") echo "ğŸ›¡ï¸  å“è³ªå„ªå…ˆï¼šå®Œå…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ" ;;
        esac 