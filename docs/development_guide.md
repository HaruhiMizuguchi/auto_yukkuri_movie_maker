# 開発ガイド - ゆっくり動画自動生成ツール

## 1. 概要

本ドキュメントでは、ゆっくり動画自動生成ツールの開発手順、テスト駆動開発（TDD）アプローチ、およびタスク分割について説明します。

## 2. 開発方針

### 2.1 テスト駆動開発（TDD）アプローチ
1. **Red**: 失敗するテストを書く
2. **Green**: テストが通る最小限のコードを書く
3. **Refactor**: コードをリファクタリングして改善

### 2.2 開発原則
- 各モジュールは独立性を保つ
- 依存関係を最小限に抑える
- 設定ファイルによる柔軟な制御
- エラーハンドリングを徹底
- ログによる処理の透明性確保

## 3. プロジェクト構造

```
auto_yukkuri_movie_maker/
├── src/                          # ソースコード
│   ├── core/                     # コアモジュール
│   │   ├── __init__.py
│   │   ├── project_manager.py    # プロジェクト管理
│   │   ├── workflow_engine.py    # ワークフロー制御
│   │   └── error_handler.py      # エラーハンドリング
│   ├── modules/                  # 各処理モジュール
│   │   ├── __init__.py
│   │   ├── theme_selector.py     # テーマ選定
│   │   ├── script_generator.py   # スクリプト生成
│   │   ├── title_generator.py    # タイトル生成
│   │   ├── tts_processor.py      # 音声生成
│   │   ├── character_animator.py # 立ち絵アニメーション
│   │   ├── background_generator.py # 背景生成
│   │   ├── subtitle_generator.py # 字幕生成
│   │   ├── video_composer.py     # 動画合成
│   │   ├── audio_enhancer.py     # 音響効果
│   │   ├── illustration_inserter.py # 挿絵挿入
│   │   ├── video_encoder.py      # 動画エンコード
│   │   └── youtube_uploader.py   # YouTube投稿
│   ├── utils/                    # ユーティリティ
│   │   ├── __init__.py
│   │   ├── file_manager.py       # ファイル管理
│   │   ├── config_loader.py      # 設定読み込み
│   │   ├── logger.py             # ロギング
│   │   └── validator.py          # バリデーション
│   └── api/                      # 外部API接続
│       ├── __init__.py
│       ├── llm_client.py         # LLM API
│       ├── tts_client.py         # TTS API
│       ├── image_gen_client.py   # 画像生成API
│       └── youtube_client.py     # YouTube API
├── tests/                        # テストコード
│   ├── unit/                     # ユニットテスト
│   ├── integration/              # 統合テスト
│   └── e2e/                      # エンドツーエンドテスト
├── config/                       # 設定ファイル
├── assets/                       # アセット
├── docs/                         # ドキュメント
├── requirements.txt              # 依存関係
├── setup.py                      # セットアップ
├── main.py                       # メインエントリーポイント
└── README.md                     # プロジェクト説明
```

## 4. タスク分割（TDD開発順序）

### フェーズ1: 基盤開発
#### タスク1-1: プロジェクト管理システム
- **目的**: プロジェクトの作成、管理、状態追跡
- **テスト内容**:
  - プロジェクト作成のテスト
  - ディレクトリ構造生成のテスト
  - プロジェクト状態管理のテスト
- **実装**: `src/core/project_manager.py`

#### タスク1-2: 設定管理システム
- **目的**: YAML/JSON設定ファイルの読み込み・バリデーション
- **テスト内容**:
  - 設定ファイル読み込みのテスト
  - 設定値検証のテスト
  - デフォルト値適用のテスト
- **実装**: `src/utils/config_loader.py`

#### タスク1-3: ログシステム
- **目的**: 構造化ログ、エラーログの出力
- **テスト内容**:
  - ログ出力のテスト
  - ログローテーションのテスト
  - エラーレベル制御のテスト
- **実装**: `src/utils/logger.py`

#### タスク1-4: データベース + ファイル管理システム
- **目的**: SQLiteデータベースとファイルシステムの統合管理
- **テスト内容**:
  - データベース初期化のテスト
  - プロジェクトディレクトリ作成のテスト
  - ファイル参照登録・取得のテスト
  - データベーストランザクションのテスト
- **実装**: 
  - `src/core/database_manager.py` - データベース管理
  - `src/core/project_repository.py` - データアクセス層
  - `src/utils/file_manager.py` - ファイルシステム管理

### フェーズ2: コア機能開発
#### タスク2-1: ワークフローエンジン
- **目的**: 各処理ステップの順次実行、並列実行制御
- **テスト内容**:
  - ステップ順序制御のテスト
  - エラー時の処理停止・継続のテスト
  - 進捗状況追跡のテスト
- **実装**: `src/core/workflow_engine.py`

#### タスク2-2: エラーハンドリングシステム
- **目的**: 例外処理、リトライ機能、復旧処理
- **テスト内容**:
  - 例外捕捉のテスト
  - リトライ機能のテスト
  - 復旧処理のテスト
- **実装**: `src/core/error_handler.py`

### フェーズ3: 外部API連携
#### タスク3-1: LLM API クライアント
- **目的**: OpenAI GPT等のLLM APIとの通信
- **テスト内容**:
  - API接続のテスト（モック使用）
  - レスポンス解析のテスト
  - エラーレスポンス処理のテスト
- **実装**: `src/api/llm_client.py`

#### タスク3-2: TTS API クライアント
- **目的**: AIVIS Speech APIとの通信
- **テスト内容**:
  - 音声生成リクエストのテスト
  - タイムスタンプ取得のテスト
  - 音声ファイル保存のテスト
- **実装**: `src/api/tts_client.py`

#### タスク3-3: 画像生成 API クライアント
- **目的**: 画像生成AIとの通信
- **テスト内容**:
  - 画像生成リクエストのテスト
  - 画像ファイル保存のテスト
  - エラーレスポンス処理のテスト
- **実装**: `src/api/image_gen_client.py`

#### タスク3-4: YouTube API クライアント
- **目的**: YouTube Data APIとの通信
- **テスト内容**:
  - 認証フローのテスト
  - 動画アップロードのテスト
  - メタデータ設定のテスト
- **実装**: `src/api/youtube_client.py`

### フェーズ4: 処理モジュール開発（ステップ順）
#### タスク4-1: テーマ選定モジュール
- **目的**: LLMを使った自動テーマ生成・選定
- **テスト内容**:
  - テーマ候補生成のテスト
  - ユーザー設定反映のテスト
  - 出力JSON形式のテスト
- **実装**: `src/modules/theme_selector.py`

#### タスク4-2: スクリプト生成モジュール
- **目的**: テーマからスクリプト自動生成
- **テスト内容**:
  - 話者数指定のテスト
  - 動画尺制御のテスト
  - セグメント分割のテスト
- **実装**: `src/modules/script_generator.py`

#### タスク4-3: タイトル生成モジュール
- **目的**: CTR最適化タイトル生成
- **テスト内容**:
  - タイトル候補生成のテスト
  - CTRスコア算出のテスト
  - 文字数制限のテスト
- **実装**: `src/modules/title_generator.py`

#### タスク4-4: TTS処理モジュール
- **目的**: スクリプトから音声ファイル生成
- **テスト内容**:
  - セグメント単位音声生成のテスト
  - タイムスタンプ抽出のテスト
  - 音声ファイル結合のテスト
- **実装**: `src/modules/tts_processor.py`

#### タスク4-5: 立ち絵アニメーションモジュール
- **目的**: 音声同期立ち絵動画生成
- **テスト内容**:
  - 口パク同期のテスト
  - 表情切替のテスト
  - 透明背景動画出力のテスト
- **実装**: `src/modules/character_animator.py`

#### タスク4-6: 背景生成モジュール
- **目的**: 背景画像生成と動画化
- **テスト内容**:
  - 画像生成のテスト
  - Ken Burnsエフェクトのテスト
  - 動画時間制御のテスト
- **実装**: `src/modules/background_generator.py`

#### タスク4-7: 字幕生成モジュール
- **目的**: 音声タイムスタンプベース字幕生成
- **テスト内容**:
  - 字幕タイミング同期のテスト
  - スタイル適用のテスト
  - ASS形式出力のテスト
- **実装**: `src/modules/subtitle_generator.py`

#### タスク4-8: 動画合成モジュール
- **目的**: 背景・立ち絵・音声・字幕の合成
- **テスト内容**:
  - レイヤー合成のテスト
  - 音声同期のテスト
  - 解像度制御のテスト
- **実装**: `src/modules/video_composer.py`

#### タスク4-9: 音響効果モジュール
- **目的**: BGM・効果音の追加
- **テスト内容**:
  - SE配置のテスト
  - 音量正規化のテスト
  - フェード処理のテスト
- **実装**: `src/modules/audio_enhancer.py`

#### タスク4-10: 挿絵挿入モジュール
- **目的**: 話題転換点での挿絵生成・挿入
- **テスト内容**:
  - 挿入タイミング検出のテスト
  - 挿絵生成のテスト
  - 動画への合成のテスト
- **実装**: `src/modules/illustration_inserter.py`

#### タスク4-11: 動画エンコードモジュール
- **目的**: 最終動画エンコード・最適化
- **テスト内容**:
  - エンコード設定適用のテスト
  - 品質チェックのテスト
  - リトライ機能のテスト
- **実装**: `src/modules/video_encoder.py`

#### タスク4-12: YouTube投稿モジュール
- **目的**: 自動YouTube投稿
- **テスト内容**:
  - 認証のテスト（モック）
  - メタデータ設定のテスト
  - アップロード完了確認のテスト
- **実装**: `src/modules/youtube_uploader.py`

### フェーズ5: 統合・UI開発
#### タスク5-1: CLI インターフェース
- **目的**: コマンドライン操作インターフェース
- **テスト内容**:
  - コマンド解析のテスト
  - 進捗表示のテスト
  - エラー表示のテスト
- **実装**: `main.py`

#### タスク5-2: 設定ファイルテンプレート
- **目的**: 各種設定ファイルのテンプレート作成
- **実装**:
  - `config/llm_config.yaml`
  - `config/voice_config.yaml`
  - `config/character_config.yaml`
  - `config/subtitle_config.yaml`
  - `config/encoding_config.yaml`
  - `config/youtube_config.yaml`

#### タスク5-3: エンドツーエンドテスト
- **目的**: 全工程通しての動作確認
- **テスト内容**:
  - フル処理フローのテスト
  - エラー発生時の挙動テスト
  - 成果物品質チェックのテスト

## 5. テスト戦略

### 5.1 ユニットテスト
- 各関数・メソッドの個別テスト
- モック使用による外部依存分離
- カバレッジ90%以上を目標

### 5.2 統合テスト
- モジュール間連携のテスト
- データベース + ファイルシステム統合のテスト
- ワークフローステップ連携のテスト
- API呼び出しのテスト（モック使用）

### 5.3 エンドツーエンドテスト
- 実際のワークフロー実行テスト
- 制限されたリソースでの実行テスト

### 5.4 テスト環境
- pytest フレームワーク使用
- CI/CD での自動テスト実行
- テストデータのサンプル準備

## 6. 開発環境セットアップ

### 6.1 必要なツール
```bash
# Python環境
python 3.8+

# FFmpeg（動画処理）
sudo apt-get install ffmpeg  # Ubuntu
brew install ffmpeg          # macOS

# その他のツール
pip install pytest pytest-cov pytest-mock
```

### 6.2 開発用依存関係
```bash
pip install -r requirements-dev.txt
```

## 7. 品質保証

### 7.1 コード品質
- flake8, black によるコード整形
- mypy による型チェック
- isort によるimport整理

### 7.2 ドキュメント
- docstring による関数説明
- 型ヒントの必須化
- APIドキュメント自動生成

### 7.3 パフォーマンス
- プロファイリングによるボトルネック特定
- メモリ使用量の監視
- 処理時間の計測・最適化

## 8. 次のステップ

1. 基盤モジュールの実装とテスト
2. 外部API連携の実装
3. 各処理モジュールの順次開発
4. 統合テストとエンドツーエンドテスト
5. UIと最終調整
6. デプロイメントとドキュメント完成 